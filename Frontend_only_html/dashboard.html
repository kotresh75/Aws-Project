<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard - Instant Library">
    <title>Dashboard - Instant Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/app.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/header-footer.css">
</head>

<body>
    <!-- Sidebar will be injected by JavaScript -->

    <div class="app-container sidebar-open">
        <main>
            <div id="dashboard-content" style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                <!-- Loading state -->
                <div class="loading" id="loading">Loading dashboard...</div>

                <!-- Content will be rendered by JavaScript -->
                <div id="content" style="display: none;"></div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/components.js"></script>
    <script>
        const user = requireAuth();
        if (!user) {
            // requireAuth will redirect
        }

        let stats = {
            totalBooks: 0,
            availableBooks: 0,
            totalStudents: 0,
            pendingRequests: 0,
            myActiveRequests: 0,
            myBorrowedBooks: 0
        };
        let recentActivity = [];

        async function fetchDashboardData() {
            try {
                // Fetch books
                const books = await apiGet('/books');
                stats.totalBooks = books.length;
                stats.availableBooks = books.reduce((acc, book) => acc + book.available_count, 0);

                if (user.role === 'staff') {
                    // Fetch students
                    try {
                        const students = await apiGet('/users?role=student');
                        stats.totalStudents = students.length;
                    } catch (e) {
                        stats.totalStudents = 0;
                    }

                    // Fetch all requests
                    try {
                        const requests = await apiGet(`/all-requests?staff_email=${user.email}`);
                        stats.pendingRequests = requests.filter(r => r.status === 'pending').length;
                        recentActivity = requests.slice(0, 5);
                    } catch (e) {
                        stats.pendingRequests = 0;
                    }
                } else {
                    // Fetch user's requests
                    try {
                        const requests = await apiGet(`/user-requests/${user.email}`);
                        stats.myActiveRequests = requests.filter(r => r.status === 'pending' || r.status === 'approved').length;
                        stats.myBorrowedBooks = requests.filter(r => r.status === 'approved').length;
                        recentActivity = requests.slice(0, 5);
                    } catch (e) {
                        stats.myActiveRequests = 0;
                        stats.myBorrowedBooks = 0;
                    }
                }

                renderDashboard();
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                document.getElementById('loading').textContent = 'Error loading dashboard';
            }
        }

        function renderDashboard() {
            document.getElementById('loading').style.display = 'none';
            const content = document.getElementById('content');
            content.style.display = 'block';

            const staffStats = user.role === 'staff' ? `
                <div class="glass-card">
                    <h3 style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Total Students</h3>
                    <p style="font-size: 2.5rem; font-weight: 800; color: var(--success); margin: 0;">${stats.totalStudents}</p>
                </div>
                <div class="glass-card">
                    <h3 style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Pending Requests</h3>
                    <p style="font-size: 2.5rem; font-weight: 800; color: var(--warning); margin: 0;">${stats.pendingRequests}</p>
                </div>
            ` : `
                <div class="glass-card">
                    <h3 style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Books Available</h3>
                    <p style="font-size: 2.5rem; font-weight: 800; color: var(--success); margin: 0;">${stats.availableBooks}</p>
                </div>
                <div class="glass-card">
                    <h3 style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Active Requests</h3>
                    <p style="font-size: 2.5rem; font-weight: 800; color: var(--warning); margin: 0;">${stats.myActiveRequests}</p>
                </div>
            `;

            const staffActions = user.role === 'staff' ? `
                <button onclick="navigateTo('book-management.html')" class="btn-secondary" style="text-align: left; justify-content: flex-start; display: flex; gap: 1rem; align-items: center; width: 100%; padding: 1rem;">
                    <span style="font-size: 1.5rem;">ðŸ“š</span>
                    <div>
                        <div style="font-weight: 600;">Manage Books</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Add, edit, or remove books</div>
                    </div>
                </button>
                <button onclick="navigateTo('request-management.html')" class="btn-secondary" style="text-align: left; justify-content: flex-start; display: flex; gap: 1rem; align-items: center; width: 100%; padding: 1rem;">
                    <span style="font-size: 1.5rem;">ðŸ“‹</span>
                    <div>
                        <div style="font-weight: 600;">Manage Requests</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Approve or reject requests</div>
                    </div>
                </button>
                <button onclick="navigateTo('student-management.html')" class="btn-secondary" style="text-align: left; justify-content: flex-start; display: flex; gap: 1rem; align-items: center; width: 100%; padding: 1rem;">
                    <span style="font-size: 1.5rem;">ðŸŽ“</span>
                    <div>
                        <div style="font-weight: 600;">Manage Students</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">View student history</div>
                    </div>
                </button>
            ` : `
                <button onclick="navigateTo('catalog.html')" class="btn-secondary" style="text-align: left; justify-content: flex-start; display: flex; gap: 1rem; align-items: center; width: 100%; padding: 1rem;">
                    <span style="font-size: 1.5rem;">ðŸ“–</span>
                    <div>
                        <div style="font-weight: 600;">Browse Catalog</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Search and borrow books</div>
                    </div>
                </button>
                <button onclick="navigateTo('requests.html')" class="btn-secondary" style="text-align: left; justify-content: flex-start; display: flex; gap: 1rem; align-items: center; width: 100%; padding: 1rem;">
                    <span style="font-size: 1.5rem;">ðŸ“‹</span>
                    <div>
                        <div style="font-weight: 600;">My Requests</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Check status of your books</div>
                    </div>
                </button>
            `;

            const activityItems = recentActivity.length > 0
                ? recentActivity.map(item => `
                    <div style="padding: 1rem; background: rgba(255,255,255,0.4); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <p style="margin: 0 0 0.25rem 0; font-weight: 600; color: var(--text-main);">${item.book_name || 'Unknown Book'}</p>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                                ${user.role === 'staff' ? `Requested by ${item.sender || 'Unknown'}` : `Author: ${item.author || 'Unknown'}`}
                            </p>
                        </div>
                        <span class="badge ${item.status === 'approved' ? 'badge-success' : item.status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                            ${item.status || 'pending'}
                        </span>
                    </div>
                `).join('')
                : '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No recent activity.</p>';

            content.innerHTML = `
                <!-- Welcome Section -->
                <div class="glass-card" style="margin-bottom: 2rem; background: rgba(255,255,255,0.6);">
                    <h1 style="font-size: 2rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        Welcome back, ${user.name}!
                    </h1>
                    <p style="color: var(--text-muted);">Here's what's happening in your library today.</p>
                </div>

                <!-- Stats Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="glass-card">
                        <h3 style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Total Books</h3>
                        <p style="font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 0;">${stats.totalBooks}</p>
                    </div>
                    ${staffStats}
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                    <!-- Recent Activity -->
                    <div class="glass-card">
                        <h2 style="font-size: 1.25rem; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 1rem;">Recent Activity</h2>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${activityItems}
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="glass-card">
                        <h2 style="font-size: 1.25rem; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 1rem;">Quick Actions</h2>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${staffActions}
                        </div>
                    </div>
                </div>
            `;
        }

        // Fetch data when page loads
        fetchDashboardData();
    </script>
</body>

</html>