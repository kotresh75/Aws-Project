<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Request Management - Instant Library">
    <title>Request Management - Instant Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/app.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/header-footer.css">
</head>

<body>
    <div class="app-container sidebar-open">
        <main>
            <div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                <div class="glass-card" style="margin-bottom: 2rem;">
                    <h1
                        style="font-size: 2rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;">
                        ðŸ“‹ Request Management
                    </h1>
                    <p style="color: var(--text-muted);">Approve or reject student book requests</p>

                    <!-- Filters -->
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <select id="status-filter"
                            style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1);">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>

                <div id="message-container" style="margin-bottom: 1rem;"></div>

                <div class="glass-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Book</th>
                                <th>Roll No</th>
                                <th>Semester</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="requests-tbody">
                            <tr>
                                <td colspan="7" class="loading">Loading requests...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/components.js"></script>
    <script>
        const user = requireAuth();
        if (user && user.role !== 'staff') {
            window.location.href = 'unauthorized.html';
        }

        let allRequests = [];

        async function fetchRequests() {
            try {
                allRequests = await apiGet(`/all-requests?staff_email=${user.email}`);
                renderRequests();
            } catch (error) {
                document.getElementById('requests-tbody').innerHTML = '<tr><td colspan="7" style="color: var(--danger);">Error loading requests</td></tr>';
            }
        }

        function renderRequests() {
            const statusFilter = document.getElementById('status-filter').value;
            let filtered = allRequests;

            if (statusFilter) {
                filtered = allRequests.filter(r => r.status === statusFilter);
            }

            const tbody = document.getElementById('requests-tbody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">No requests found.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(req => `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${req.sender || 'Unknown'}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${req.email || ''}</div>
                    </td>
                    <td>${req.book_name || 'Unknown'}</td>
                    <td>${req.roll_no || 'N/A'}</td>
                    <td>${req.semester || 'N/A'}</td>
                    <td>${formatDate(req.requested_at)}</td>
                    <td>
                        <span class="badge ${req.status === 'approved' ? 'badge-success' : req.status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                            ${req.status || 'pending'}
                        </span>
                    </td>
                    <td>
                        ${req.status === 'pending' ? `
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="updateRequest(${req.request_id}, 'approved')" class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; background: var(--success);">Approve</button>
                                <button onclick="updateRequest(${req.request_id}, 'rejected')" class="btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Reject</button>
                            </div>
                        ` : '<span style="color: var(--text-muted);">â€”</span>'}
                    </td>
                </tr>
            `).join('');
        }

        async function updateRequest(requestId, status) {
            try {
                await apiPut(`/requests/${requestId}`, {
                    status
                });
                showMessage(`Request ${status} successfully!`);
                fetchRequests();
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }

        function showMessage(msg, isError = false) {
            document.getElementById('message-container').innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${msg}</div>`;
            setTimeout(() => document.getElementById('message-container').innerHTML = '', 3000);
        }

        document.getElementById('status-filter').addEventListener('change', renderRequests);

        fetchRequests();
    </script>
</body>

</html>