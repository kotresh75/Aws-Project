<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Book Management - Instant Library">
    <title>Book Management - Instant Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/app.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/header-footer.css">
</head>

<body>
    <div class="app-container sidebar-open">
        <main>
            <div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                <div class="glass-card" style="margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h1
                                style="font-size: 2rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;">
                                ðŸ“š Book Management
                            </h1>
                            <p style="color: var(--text-muted);">Add, edit, and manage library books</p>
                        </div>
                        <button onclick="openAddModal()" class="btn-primary">+ Add New Book</button>
                    </div>
                </div>

                <div id="message-container" style="margin-bottom: 1rem;"></div>

                <div class="glass-table-container">
                    <table id="books-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Subject</th>
                                <th>Available</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="books-tbody">
                            <tr>
                                <td colspan="6" class="loading">Loading books...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Modal -->
            <div id="book-modal"
                style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 2rem;">
                <div class="glass-card"
                    style="width: 90%; max-width: 600px; background: rgba(255,255,255,0.95); margin: auto;"
                    onclick="event.stopPropagation();">
                    <h2 id="modal-title" style="margin-bottom: 1.5rem;">Add New Book</h2>

                    <form id="book-form">
                        <input type="hidden" id="book-id">

                        <div class="form-group">
                            <label for="book-title">Title *</label>
                            <input type="text" id="book-title" required>
                        </div>

                        <div class="form-group">
                            <label for="book-author">Author *</label>
                            <input type="text" id="book-author" required>
                        </div>

                        <div class="form-group">
                            <label for="book-subject">Subject *</label>
                            <input type="text" id="book-subject" required>
                        </div>

                        <div class="form-group">
                            <label for="book-description">Description</label>
                            <textarea id="book-description" rows="3"></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="book-year">Year</label>
                                <input type="number" id="book-year" value="2024">
                            </div>
                            <div class="form-group">
                                <label for="book-quantity">Quantity</label>
                                <input type="number" id="book-quantity" value="1" min="1">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="book-isbn">ISBN</label>
                            <input type="text" id="book-isbn">
                        </div>

                        <div class="form-group">
                            <label for="book-cover">Cover Image URL</label>
                            <input type="url" id="book-cover" placeholder="https://...">
                        </div>

                        <div class="form-group">
                            <label for="book-pdf">PDF URL</label>
                            <input type="url" id="book-pdf" placeholder="https://...">
                        </div>

                        <div id="modal-error" style="display: none;"></div>

                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button type="submit" class="btn-primary" style="flex: 1;">Save Book</button>
                            <button type="button" onclick="closeModal()" class="btn-secondary"
                                style="flex: 1;">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/components.js"></script>
    <script>
        const user = requireAuth();
        if (user && user.role !== 'staff') {
            window.location.href = 'unauthorized.html';
        }

        let books = [];
        let editingBook = null;

        async function fetchBooks() {
            try {
                books = await apiGet('/books');
                renderBooks();
            } catch (error) {
                document.getElementById('books-tbody').innerHTML = '<tr><td colspan="6" style="color: var(--danger);">Error loading books</td></tr>';
            }
        }

        function renderBooks() {
            const tbody = document.getElementById('books-tbody');

            if (books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">No books found. Add your first book!</td></tr>';
                return;
            }

            tbody.innerHTML = books.map(book => `
                <tr>
                    <td style="font-weight: 600;">${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.subject}</td>
                    <td><span class="badge ${book.available_count > 0 ? 'badge-success' : 'badge-danger'}">${book.available_count}</span></td>
                    <td>${book.total_count}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="openEditModal(${book.id})" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Edit</button>
                            <button onclick="deleteBook(${book.id})" class="btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openAddModal() {
            editingBook = null;
            document.getElementById('modal-title').textContent = 'Add New Book';
            document.getElementById('book-form').reset();
            document.getElementById('book-id').value = '';
            document.getElementById('book-modal').style.display = 'flex';
        }

        function openEditModal(bookId) {
            editingBook = books.find(b => b.id === bookId);
            if (!editingBook) return;

            document.getElementById('modal-title').textContent = 'Edit Book';
            document.getElementById('book-id').value = editingBook.id;
            document.getElementById('book-title').value = editingBook.title || '';
            document.getElementById('book-author').value = editingBook.author || '';
            document.getElementById('book-subject').value = editingBook.subject || '';
            document.getElementById('book-description').value = editingBook.description || '';
            document.getElementById('book-year').value = editingBook.year || 2024;
            document.getElementById('book-quantity').value = editingBook.total_count || 1;
            document.getElementById('book-isbn').value = editingBook.isbn || '';
            document.getElementById('book-cover').value = editingBook.cover_image || '';
            document.getElementById('book-pdf').value = editingBook.pdf_url || '';

            document.getElementById('book-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('book-modal').style.display = 'none';
            document.getElementById('modal-error').style.display = 'none';
        }

        document.getElementById('book-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const bookData = {
                staff_email: user.email,
                title: document.getElementById('book-title').value.trim(),
                author: document.getElementById('book-author').value.trim(),
                subject: document.getElementById('book-subject').value.trim(),
                description: document.getElementById('book-description').value.trim(),
                year: parseInt(document.getElementById('book-year').value) || 2024,
                quantity: parseInt(document.getElementById('book-quantity').value) || 1,
                total_count: parseInt(document.getElementById('book-quantity').value) || 1,
                isbn: document.getElementById('book-isbn').value.trim(),
                cover_image: document.getElementById('book-cover').value.trim(),
                pdf_url: document.getElementById('book-pdf').value.trim()
            };

            try {
                if (editingBook) {
                    await apiPut(`/books/${editingBook.id}`, bookData);
                    showMessage('Book updated successfully!');
                } else {
                    await apiPost('/books', bookData);
                    showMessage('Book added successfully!');
                }
                closeModal();
                fetchBooks();
            } catch (error) {
                document.getElementById('modal-error').innerHTML = `<div class="error-message">${error.message}</div>`;
                document.getElementById('modal-error').style.display = 'block';
            }
        });

        async function deleteBook(bookId) {
            if (!confirm('Are you sure you want to delete this book?')) return;

            try {
                await apiDelete(`/books/${bookId}`, { staff_email: user.email });
                showMessage('Book deleted successfully!');
                fetchBooks();
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }

        function showMessage(msg, isError = false) {
            document.getElementById('message-container').innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${msg}</div>`;
            setTimeout(() => document.getElementById('message-container').innerHTML = '', 3000);
        }

        fetchBooks();
    </script>
</body>

</html>