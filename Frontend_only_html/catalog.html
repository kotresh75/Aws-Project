<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Book Catalog - Instant Library">
    <title>Book Catalog - Instant Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/app.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/header-footer.css">
</head>

<body>
    <div class="app-container sidebar-open">
        <main>
            <div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                <!-- Header -->
                <div class="glass-card" style="margin-bottom: 2rem; text-align: center;">
                    <h1
                        style="font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        ðŸ“– Book Catalog
                    </h1>
                    <p style="color: var(--text-muted);">Search and request books from our library collection</p>

                    <div id="message-container" style="margin-top: 1rem;"></div>

                    <!-- Search & Filter -->
                    <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                        <input type="text" id="search-input" placeholder="Search by title or author..."
                            style="padding: 0.75rem 1rem; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8); min-width: 300px;">
                        <select id="subject-filter"
                            style="padding: 0.75rem 1rem; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8);">
                            <option value="">All Subjects</option>
                        </select>
                    </div>
                </div>

                <!-- Books Grid -->
                <div id="books-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem;">
                    <div class="loading">Loading books...</div>
                </div>
            </div>

            <!-- Request Modal -->
            <div id="request-modal"
                style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); align-items: center; justify-content: center; z-index: 1000;">
                <div class="glass-card" style="width: 90%; max-width: 500px; background: rgba(255,255,255,0.95);"
                    onclick="event.stopPropagation();">
                    <h2 style="margin-bottom: 1.5rem; color: var(--text-main);">Request Book</h2>
                    <div id="modal-book-info"
                        style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.03); border-radius: 8px;">
                    </div>

                    <div id="student-fields"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="grid-column: 1 / -1;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Roll No</label>
                            <input type="text" id="modal-roll-no"
                                style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ddd;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Semester</label>
                            <input type="text" id="modal-semester"
                                style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ddd;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Year</label>
                            <input type="text" id="modal-year"
                                style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ddd;">
                        </div>
                    </div>

                    <div id="modal-error" style="display: none;"></div>

                    <div style="display: flex; gap: 1rem;">
                        <button id="confirm-request-btn" class="btn-primary" style="flex: 1;">Confirm</button>
                        <button onclick="closeModal()" class="btn-danger"
                            style="flex: 1; background: transparent; color: var(--danger); border: 1px solid var(--danger);">Cancel</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/components.js"></script>
    <script>
        const user = requireAuth();
        let books = [];
        let filteredBooks = [];
        let selectedBook = null;

        // Initialize
        async function init() {
            // Pre-fill student details
            if (user.role === 'student') {
                document.getElementById('modal-roll-no').value = user.roll_no || '';
                document.getElementById('modal-semester').value = user.semester || '';
                document.getElementById('modal-year').value = user.year || '';
            } else {
                document.getElementById('student-fields').style.display = 'none';
            }

            await fetchBooks();
            setupEventListeners();
        }

        async function fetchBooks() {
            try {
                books = await apiGet('/books');
                const subjects = [...new Set(books.map(b => b.subject))].sort();

                // Populate subject filter
                const subjectFilter = document.getElementById('subject-filter');
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectFilter.appendChild(option);
                });

                filteredBooks = books;
                renderBooks();
            } catch (error) {
                document.getElementById('books-grid').innerHTML = '<p style="color: var(--danger); text-align: center; grid-column: 1/-1;">Error loading books</p>';
            }
        }

        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', filterBooks);
            document.getElementById('subject-filter').addEventListener('change', filterBooks);
            document.getElementById('request-modal').addEventListener('click', closeModal);
            document.getElementById('confirm-request-btn').addEventListener('click', confirmRequest);
        }

        function filterBooks() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const selectedSubject = document.getElementById('subject-filter').value;

            filteredBooks = books.filter(book => {
                const matchesSearch = !searchTerm ||
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm);
                const matchesSubject = !selectedSubject || book.subject === selectedSubject;
                return matchesSearch && matchesSubject;
            });

            renderBooks();
        }

        function renderBooks() {
            const grid = document.getElementById('books-grid');

            if (filteredBooks.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-muted);">No books found matching your criteria.</div>';
                return;
            }

            grid.innerHTML = filteredBooks.map(book => `
                <div class="glass-card" style="display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        ${book.cover_image ? `
                            <div style="flex-shrink: 0; width: 80px; height: 120px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <img src="${book.cover_image}" alt="${book.title}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                        <div style="flex: 1;">
                            <h3 style="font-size: 1.2rem; margin-bottom: 0.25rem; color: var(--text-main);">${book.title}</h3>
                            <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">by ${book.author}</p>
                            <div style="margin-top: 0.5rem;">
                                <span class="badge ${book.available_count > 0 ? 'badge-success' : 'badge-danger'}">
                                    ${book.available_count > 0 ? 'Available' : 'Out of Stock'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div style="font-size: 0.9rem; color: var(--text-main); margin-bottom: 1rem; flex: 1;">
                        <p><strong>Subject:</strong> ${book.subject}</p>
                        <p><strong>Copies:</strong> ${book.available_count} / ${book.total_count}</p>
                    </div>

                    <button onclick="openRequestModal(${book.id})" class="${book.available_count > 0 ? 'btn-primary' : 'btn-secondary'}" 
                            style="width: 100%; ${book.available_count <= 0 ? 'background: linear-gradient(135deg, var(--warning), #d97706); color: white; border: none;' : ''}">
                        ${book.available_count > 0 ? 'Request Book' : 'Request Restock'}
                    </button>

                    ${book.pdf_url ? `
                        <button onclick="window.open('${book.pdf_url}', '_blank')" class="btn-secondary" style="width: 100%; margin-top: 0.5rem;">
                            Read PDF
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function openRequestModal(bookId) {
            selectedBook = books.find(b => b.id === bookId);
            if (!selectedBook) return;

            document.getElementById('modal-book-info').innerHTML = `
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">${selectedBook.title}</h3>
                <p style="margin: 0; color: var(--text-muted);">Author: ${selectedBook.author}</p>
                ${selectedBook.cover_image ? `
                    <img src="${selectedBook.cover_image}" alt="${selectedBook.title}" 
                         style="width: 100px; height: 150px; object-fit: cover; border-radius: 4px; margin-top: 1rem; display: block; margin-left: auto; margin-right: auto;"
                         onerror="this.style.display='none'">
                ` : ''}
            `;

            document.getElementById('request-modal').style.display = 'flex';
            document.getElementById('modal-error').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('request-modal').style.display = 'none';
            selectedBook = null;
        }

        async function confirmRequest() {
            if (!selectedBook) return;

            const roll_no = document.getElementById('modal-roll-no').value.trim();
            const semester = document.getElementById('modal-semester').value.trim();
            const year = document.getElementById('modal-year').value.trim();

            if (user.role === 'student' && (!roll_no || !semester || !year)) {
                document.getElementById('modal-error').innerHTML = '<div class="error-message">Please fill in all details</div>';
                document.getElementById('modal-error').style.display = 'block';
                return;
            }

            try {
                await apiPost('/requests', {
                    email: user.email,
                    book_id: selectedBook.id,
                    roll_no,
                    semester,
                    year
                });

                closeModal();
                showMessage(`âœ… Request submitted for "${selectedBook.title}"`);
                setTimeout(() => hideMessage(), 3000);
            } catch (error) {
                document.getElementById('modal-error').innerHTML = `<div class="error-message">${error.message}</div>`;
                document.getElementById('modal-error').style.display = 'block';
            }
        }

        function showMessage(msg) {
            document.getElementById('message-container').innerHTML = `<div class="success-message">${msg}</div>`;
        }

        function hideMessage() {
            document.getElementById('message-container').innerHTML = '';
        }

        init();
    </script>
</body>

</html>