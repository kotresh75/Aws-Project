{% extends 'base.html' %}

{% block content %}
<div class="container" style="padding-top: 120px; padding-bottom: 4rem;">

    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
        <div>
            <div style="margin-bottom: 1rem;">
                <a href="{{ url_for('staff_dashboard') }}" class="btn-outline"
                    style="padding: 0.5rem 1rem; border-radius: 8px;">
                    &larr; Back to Dashboard
                </a>
            </div>
            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Manage <span class="text-gradient">Requests</span>
            </h1>
            <p style="color: var(--text-secondary);">Review and process student book requests.</p>
        </div>
    </div>

    <!-- Requests Table -->
    <div class="glass-panel" style="padding: 2rem;">
        {% if requests | selectattr("status", "equalto", "pending") | list | length == 0 %}
        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ‰</div>
            <p style="font-size: 1.1rem;">All caught up! No pending requests.</p>
        </div>
        {% else %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Student Email</th>
                    <th>Cover</th>
                    <th>Book Requested</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for req in requests %}
                {% if req.status == 'pending' %}
                <tr>
                    <td>{{ req.user_email }}</td>
                    <td>
                        {% if req.book_cover %}
                        <img src="{{ req.book_cover }}" alt="Cover"
                            style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px;">
                        {% else %}
                        <div
                            style="width: 40px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                            ðŸ“–</div>
                        {% endif %}
                    </td>
                    <td style="color: var(--primary-color); font-weight: 600;">{{ req.book_title }}</td>
                    <td>{{ req.date }}</td>
                    <td><span class="badge"
                            style="background: rgba(255, 179, 0, 0.1); color: var(--warning);">Pending</span></td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="{{ url_for('handle_request', req_id=req.id, action='approve') }}"
                                class="btn-icon btn-approve" title="Approve">âœ“</a>
                            <a href="{{ url_for('handle_request', req_id=req.id, action='reject') }}"
                                class="btn-icon btn-reject" title="Reject">âœ•</a>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if requests | selectattr("status", "ne", "pending") | list | length > 0 %}
        <div style="margin-top: 4rem;">
            <h3 style="margin-bottom: 1rem; color: var(--text-muted); font-size: 1.1rem;">Recent History</h3>
            <table class="data-table" style="opacity: 0.7;">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Cover</th>
                        <th>Book</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    {% if req.status != 'pending' %}
                    <tr>
                        <td>{{ req.user_email }}</td>
                        <td>
                            {% if req.book_cover %}
                            <img src="{{ req.book_cover }}" alt="Cover"
                                style="width: 30px; height: 45px; object-fit: cover; border-radius: 3px; opacity: 0.8;">
                            {% else %}
                            <div
                                style="width: 30px; height: 45px; background: rgba(255,255,255,0.05); border-radius: 3px;">
                            </div>
                            {% endif %}
                        </td>
                        <td>{{ req.book_title }}</td>
                        <td>{{ req.date }}</td>
                        <td>
                            {% if req.status == 'approved' %}
                            <span style="color: var(--success); margin-right: 1rem;">Approved</span>
                            <a href="{{ url_for('handle_request', req_id=req.id, action='return') }}"
                                class="btn btn-outline" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Mark
                                Returned</a>
                            {% elif req.status == 'returned' %}
                            <span style="color: var(--text-muted);">Returned</span>
                            {% elif req.status == 'pending' %}
                            <div style="display: flex; gap: 0.5rem;">
                                <a href="{{ url_for('handle_request', req_id=req.id, action='approve') }}"
                                    class="btn-icon btn-approve" title="Approve">âœ“</a>
                                <a href="{{ url_for('handle_request', req_id=req.id, action='reject') }}"
                                    class="btn-icon btn-reject" title="Reject">âœ•</a>
                            </div>
                            {% elif req.status == 'waitlisted' %}
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="color: #ff8800; font-size: 0.85rem;">[Waitlist]</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <a href="{{ url_for('handle_request', req_id=req.id, action='approve') }}"
                                        class="btn-icon btn-approve" title="Approve (If Stock Available)">âœ“</a>
                                    <a href="{{ url_for('handle_request', req_id=req.id, action='reject') }}"
                                        class="btn-icon btn-reject" title="Reject">âœ•</a>
                                </div>
                            </div>
                            {% else %}
                            <span style="color: var(--danger);">Rejected</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Table Styles */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        text-align: left;
        padding: 1rem;
        color: var(--text-muted);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.9rem;
    }

    .data-table td {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .data-table tr:hover td {
        background: rgba(255, 255, 255, 0.02);
    }

    /* Action Buttons */
    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: transform 0.2s;
        text-decoration: none;
    }

    .btn-icon:hover {
        transform: scale(1.1);
    }

    .btn-approve {
        background: rgba(0, 255, 157, 0.2);
        color: var(--success);
    }

    .btn-reject {
        background: rgba(255, 0, 85, 0.2);
        color: var(--danger);
    }

    .badge {
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        font-size: 0.8rem;
    }
</style>
{% endblock %}