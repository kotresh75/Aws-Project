{% extends 'base.html' %}

{% block content %}
<div class="container" style="padding-top: 120px; padding-bottom: 4rem;">

    <!-- Welcome Header -->
    <div style="margin-bottom: 3rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Book <span class="text-gradient">Catalog</span></h1>
        <p style="color: var(--text-secondary);">Browse our collection and request books.</p>
    </div>

    <!-- Search Bar -->
    <div style="margin-bottom: 2rem; position: relative;">
        <input type="text" id="searchInput" onkeyup="filterBooks()"
            placeholder="Search by title, author, or category..." class="form-control"
            style="padding: 1rem 1.5rem; font-size: 1.1rem; border-radius: 50px; padding-left: 3.5rem;">
        <span
            style="position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; opacity: 0.5;">üîç</span>
    </div>

    <div class="book-grid" id="bookGrid">
        {% for book in books %}
        <div class="glass-panel book-card">
            <div style="margin-bottom: 1rem; position: relative;">
                {% if book.cover_url %}
                <img src="{{ book.cover_url }}" alt="{{ book.title }}"
                    style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;">
                {% else %}
                <div
                    style="width: 100%; height: 200px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; font-size: 3rem;">
                    üìñ</div>
                {% endif %}
                <span class="badge"
                    style="background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); position: absolute; top: 10px; right: 10px;">{{
                    book.category }}</span>
            </div>
            <h3 class="book-title">{{ book.title }}</h3>
            <p class="book-author" style="color: var(--text-muted); margin-bottom: 1rem;">by {{ book.author }}</p>

            <div style="margin-top: auto; display: flex; justify-content: space-between; align-items: center;">
                {% if book.copies > 0 %}
                <span style="color: var(--success); font-size: 0.85rem;">{{ book.copies }} Available</span>
                {% else %}
                <span style="color: var(--warning); font-size: 0.85rem;">Out of Stock (Waitlist Available)</span>
                {% endif %}

                <!-- Check if user already requested this book -->
                {% set requested = false %}
                {% set req_status = '' %}
                {% for req in my_requests %}
                {% if req.book_id == book.id and (req.status == 'pending' or req.status == 'waitlisted') %}
                {% set requested = true %}
                {% set req_status = req.status %}
                {% endif %}
                {% endfor %}

                {% if requested %}
                <button disabled class="btn btn-outline" style="opacity: 0.5; padding: 0.4rem 1rem;">
                    {{ 'Waitlisted' if req_status == 'waitlisted' else 'Pending' }}
                </button>
                {% else %}
                <a href="{{ url_for('request_book', book_id=book.id) }}" class="btn btn-primary"
                    style="padding: 0.4rem 1rem; font-size: 0.9rem;">Request</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="noResults" style="text-align: center; padding: 4rem; display: none; color: var(--text-muted);">
        <div style="font-size: 3rem; margin-bottom: 1rem;">ü§î</div>
        <p>No books found matching your search.</p>
    </div>

</div>

<style>
    .book-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .book-card {
        display: flex;
        flex-direction: column;
        transition: transform 0.2s;
        height: 100%;
    }

    .book-card:hover {
        transform: translateY(-5px);
    }

    .book-title {
        margin-bottom: 0.2rem;
        font-size: 1.2rem;
    }

    .badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
</style>

<script>
    function filterBooks() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const grid = document.getElementById('bookGrid');
        const cards = grid.getElementsByClassName('book-card');
        let hasVisible = false;

        for (let i = 0; i < cards.length; i++) {
            const title = cards[i].querySelector('.book-title').textContent || cards[i].querySelector('.book-title').innerText;
            const author = cards[i].querySelector('.book-author').textContent || cards[i].querySelector('.book-author').innerText;

            if (title.toLowerCase().indexOf(filter) > -1 || author.toLowerCase().indexOf(filter) > -1) {
                cards[i].style.display = "";
                hasVisible = true;
            } else {
                cards[i].style.display = "none";
            }
        }

        document.getElementById('noResults').style.display = hasVisible ? "none" : "block";
    }
</script>
{% endblock %}